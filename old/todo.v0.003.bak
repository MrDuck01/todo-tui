
from prompt_toolkit import Application
from prompt_toolkit.key_binding import KeyBindings
from prompt_toolkit.layout import Layout
from prompt_toolkit.layout.controls import FormattedTextControl
from prompt_toolkit.layout.containers import Window
from prompt_toolkit.styles import Style
from prompt_toolkit.shortcuts import PromptSession
import asyncio


from task import Task
import storage

session = PromptSession()

# Initialise storage
storage.init_db()
tasks = storage.get_all_tasks()
current_index = 0

def get_task_text():
    lines = []

    if not tasks:
        return[("class:text", "No tasks\n")]
    
    for i, task in enumerate(tasks):
        style = "class:selected" if i == current_index else "class:text"
        lines.append((style, f"{i + 1}. {task}\n"))

    return lines

task_control = FormattedTextControl(get_task_text)
task_window = Window(content = task_control)

layout = Layout(task_window)

kb = KeyBindings()

@kb.add("up")
def move_up(event):
    global current_index
    if tasks:
        current_index = max(0, current_index - 1)

@kb.add("down")
def move_down(event):
    global current_index
    if tasks:
        current_index = min(len(tasks) -1, current_index + 1)

@kb.add("enter")
def toggle_complete(event):
    if not tasks:
        return
    
    task = tasks[current_index]
    if task.status == "active":
        task.mark_complete()
    else:
        task.status = "active"

    storage.update_task(task)

@kb.add("a")
def add_task(event):
    async def _add():
        name = await session.prompt_async("New task: ")

        if name.strip():
            task = Task(name)
            storage.insert_task(task)
            tasks.append(task)
        
    asyncio.create_task(_add())
        

@kb.add("d")
def delete_task(event):
    global current_index
    if not tasks:
        return

    task = tasks[current_index]
    storage.delete_task(task)
    tasks.pop(current_index)
    curent_index = max(0, current_index - 1)

@kb.add("q")
def quit_app(event):
    event.app.exit()

style = Style.from_dict({
    "text": "",
    "selected": "reverse",
})

app = Application(
    layout = layout,
    key_bindings = kb,
    style = style,
    full_screen = True
)

app.run()